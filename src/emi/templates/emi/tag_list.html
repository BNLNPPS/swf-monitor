{% extends "monitor_app/_datatable_base.html" %}

{% block extra_filters %}
<div class="card mb-3">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <a href="{% url 'emi:tag_create' tag_type=tag_type %}" class="btn btn-primary btn-sm">New {{ schema.label }} Tag</a>
            </div>
        </div>
        <div class="filter-bar mb-2">
            <div style="margin-bottom: 0.5em;">
                <span style="font-weight: 600;">Status:</span>
                <a href="#" data-filter="status" data-value="" class="filter-link {% if not selected_status %}filter-active{% endif %}">All</a>
                {% for s in statuses %}
                <a href="#" data-filter="status" data-value="{{ s }}" class="filter-link {% if selected_status == s %}filter-active{% endif %}">{{ s }}</a>
                {% endfor %}
            </div>
            {% if categories %}
            <div>
                <span style="font-weight: 600;">Category:</span>
                <a href="#" data-filter="category" data-value="" class="filter-link {% if not selected_category %}filter-active{% endif %}">All</a>
                {% for cat in categories %}
                <a href="#" data-filter="category" data-value="{{ cat }}" class="filter-link {% if selected_category == cat %}filter-active{% endif %}">{{ cat }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div id="active-filters" class="mt-2" style="display: none;">
            <strong>Active filters:</strong>
            <span id="filter-badges"></span>
            <button type="button" id="clear-all-filters" class="btn btn-link btn-sm p-0 ms-2">clear all</button>
        </div>
    </div>
</div>
{% endblock %}

{% block initial_filters %}
{
    status: '{{ selected_status|default:"" }}',
    category: '{{ selected_category|default:"" }}'
}
{% endblock %}

{% block default_order %}[[0, 'asc']]{% endblock %}

{% block update_active_filters_display %}
const badges = [];
const parts = [];
if (currentFilters.status) parts.push(currentFilters.status);
if (currentFilters.category) parts.push(currentFilters.category);
if (parts.length > 0) {
    badges.push(`<span class="badge bg-info me-1">${parts.join(' / ')}</span>`);
}
if (badges.length > 0) {
    $('#filter-badges').html(badges.join(''));
    $('#active-filters').show();
} else {
    $('#active-filters').hide();
}
$('.filter-link').removeClass('filter-active');
$('.filter-link[data-filter="status"][data-value="' + currentFilters.status + '"]').addClass('filter-active');
$('.filter-link[data-filter="category"][data-value="' + currentFilters.category + '"]').addClass('filter-active');
{% endblock %}

{% block extra_scripts %}
$('.filter-link').on('click', function(e) {
    e.preventDefault();
    const filterType = $(this).data('filter');
    const filterValue = $(this).data('value');
    window.tableCurrentFilters[filterType] = filterValue;
    window.tableUpdateFilters();
});
$('#clear-all-filters').on('click', function() {
    window.tableCurrentFilters.status = '';
    window.tableCurrentFilters.category = '';
    window.tableUpdateFilters();
});
{% endblock %}
