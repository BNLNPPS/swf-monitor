{% extends "base.html" %}
{% comment %}
Base template for server-side DataTables implementation.

Required context variables:
- table_title: Page title (e.g., "Log List")
- table_description: One-line description (e.g., "Server-side processing with live search...")
- ajax_url: URL for DataTables AJAX endpoint
- columns: List of column definitions for DataTables
- filter_form_id: ID for custom filter form (optional)

Optional blocks:
- extra_filters: Custom filter controls
- extra_styles: Additional CSS
- extra_scripts: Additional JavaScript

Example usage in child template:
{% extends "monitor_app/_datatable_base.html" %}
{% block extra_filters %}
    <!-- Custom filter controls here -->
{% endblock %}
{% endcomment %}

{% block title %}{{ table_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ table_title }}</h2>
    <p>{{ table_description }}</p>

    <style>
    .filter-bar a {
        margin-right: 0.5em;
        color: #007bff;
        text-decoration: none;
    }
    .filter-bar a.filter-active {
        font-weight: bold;
        text-decoration: underline;
        color: #0056b3;
    }
    
    /* Clean pagination styling */
    .dataTables_paginate {
        margin-top: 1rem !important;
    }
    .dataTables_paginate .paginate_button {
        display: inline-block !important;
        padding: 0.375rem 0.75rem !important;
        margin: 0 0.125rem !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.25rem !important;
        background: white !important;
        color: #007bff !important;
        text-decoration: none !important;
        line-height: 1.5 !important;
    }
    .dataTables_paginate .paginate_button:hover {
        background: #e9ecef !important;
        border-color: #adb5bd !important;
    }
    .dataTables_paginate .paginate_button.current {
        background: #007bff !important;
        border-color: #007bff !important;
        color: white !important;
    }
    .dataTables_paginate .paginate_button.disabled {
        color: #6c757d !important;
        background: #e9ecef !important;
        border-color: #dee2e6 !important;
        cursor: not-allowed !important;
    }
    /* Remove default list styling */
    .dataTables_paginate ul {
        list-style: none !important;
        padding: 0 !important;
        margin: 0 !important;
        display: flex !important;
        flex-wrap: wrap !important;
        align-items: center !important;
    }
    .dataTables_paginate li {
        margin: 0 !important;
    }
    
    /* Align info and pagination on same line below table */
    .dataTables_wrapper .bottom {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-top: 0.75rem !important;
    }
    .dataTables_info {
        margin-bottom: 0 !important;
    }
    .dataTables_paginate {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }
    
    {% block extra_styles %}{% endblock %}
    </style>

    {% block extra_filters %}
    <!-- Custom filter controls go here in child templates -->
    {% endblock %}

    <!-- DataTable -->
    <div class="table-responsive">
        <table id="main-table" class="table table-striped table-bordered table-sm">
            <thead class="thead-dark">
                <tr>
                    {% for column in columns %}
                        <th>{{ column.title }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <!-- DataTables will populate this via AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- External Dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize flatpickr for datetime inputs (if any)
    flatpickr('input[type="datetime-local"]', { 
        enableTime: true, 
        dateFormat: "Y-m-d H:i", 
        allowInput: true 
    });

    // Current filter state - child templates should override this
    let currentFilters = {% block initial_filters %}{}{% endblock %};

    // Initialize DataTable with server-side processing
    const table = $('#main-table').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ ajax_url }}',
            data: function(d) {
                // Add current filters to DataTables request
                Object.keys(currentFilters).forEach(key => {
                    d[key] = currentFilters[key];
                });
            }
        },
        columns: [
            {% for column in columns %}
                { data: {{ forloop.counter0 }}, name: '{{ column.name }}', orderable: {{ column.orderable|yesno:"true,false" }} }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        order: {% block default_order %}[[0, 'desc']]{% endblock %},
        pageLength: {% block page_length %}100{% endblock %},
        lengthMenu: {% block length_menu %}[[100, 300, 1000, -1], [100, 300, 1000, 'All']]{% endblock %},
        responsive: true,
        pagingType: "full_numbers",
        language: {
            processing: "Loading data...",
            search: "Search:",
            lengthMenu: "Show _MENU_ entries per page.",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: "First",
                last: "Last", 
                next: "Next",
                previous: "Previous"
            },
            emptyTable: "No data found matching your criteria."
        },
        dom: '<"top"lf>rt<"bottom"ip><"clear">',
        drawCallback: function() {
            // Custom pagination with page ranges
            updatePaginationLabels(this);
            // Update length menu with total count
            updateLengthMenuText(this);
        }
    });

    // URL and filter management functions
    function updateUrlAndFilters() {
        // Update URL with current filters
        const params = new URLSearchParams();
        Object.keys(currentFilters).forEach(key => {
            if (currentFilters[key]) {
                params.set(key, currentFilters[key]);
            }
        });
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.history.replaceState({}, '', newUrl);

        // Update active filters display
        updateActiveFiltersDisplay();
        
        // Reload DataTable
        table.ajax.reload();
    }

    function updateActiveFiltersDisplay() {
        {% block update_active_filters_display %}
        // Default implementation - child templates should override
        {% endblock %}
    }

    // Update length menu text to show total entries
    function updateLengthMenuText(table) {
        const api = table.api();
        const info = api.page.info();
        const totalEntries = info.recordsDisplay;
        
        // Find the length menu label and add total count after it
        const $lengthLabel = $('.dataTables_length label');
        if ($lengthLabel.length) {
            // Remove any existing total count span
            $lengthLabel.find('.total-count').remove();
            
            // Add the total count as a separate span
            $lengthLabel.append(` <span class="total-count">${totalEntries.toLocaleString()} total entries passing filter.</span>`);
        }
    }

    // Custom pagination labels showing ranges instead of page numbers
    function updatePaginationLabels(table) {
        const api = table.api();
        const info = api.page.info();
        const pageLength = info.length;
        const currentPage = info.page + 1; // DataTables uses 0-based indexing
        
        // Only update if not showing all records
        if (pageLength > 0 && pageLength !== -1) {
            $('.dataTables_paginate .paginate_button:not(.previous):not(.next):not(.first):not(.last)').each(function() {
                const $this = $(this);
                const pageNum = parseInt($this.text());
                
                if (!isNaN(pageNum)) {
                    const startRecord = ((pageNum - 1) * pageLength) + 1;
                    const endRecord = Math.min(pageNum * pageLength, info.recordsDisplay);
                    $this.text(`${startRecord}-${endRecord}`);
                    
                    // Ensure current page styling is preserved
                    if (pageNum === currentPage) {
                        $this.addClass('current');
                    }
                }
            });
        }
    }

    // Expose functions for child templates
    window.tableUpdateFilters = updateUrlAndFilters;
    window.tableCurrentFilters = currentFilters;
    window.tableInstance = table;

    {% block extra_scripts %}
    // Child template scripts go here
    {% endblock %}

    // Initialize display
    updateActiveFiltersDisplay();
});
</script>
{% endblock %}