{% extends "base.html" %}

{% block title %}Log List{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Log List</h2>
    <p>Server-side processing with live search, sorting, and filtering across all log records.</p>

    <style>
    .filter-bar a {
        margin-right: 0.5em;
        color: #007bff;
        text-decoration: none;
    }
    .filter-bar a.filter-active {
        font-weight: bold;
        text-decoration: underline;
        color: #0056b3;
    }
    
    /* Clean pagination styling */
    .dataTables_paginate {
        margin-top: 1rem !important;
    }
    .dataTables_paginate .paginate_button {
        display: inline-block !important;
        padding: 0.375rem 0.75rem !important;
        margin: 0 0.125rem !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.25rem !important;
        background: white !important;
        color: #007bff !important;
        text-decoration: none !important;
        line-height: 1.5 !important;
    }
    .dataTables_paginate .paginate_button:hover {
        background: #e9ecef !important;
        border-color: #adb5bd !important;
    }
    .dataTables_paginate .paginate_button.current {
        background: #007bff !important;
        border-color: #007bff !important;
        color: white !important;
    }
    .dataTables_paginate .paginate_button.disabled {
        color: #6c757d !important;
        background: #e9ecef !important;
        border-color: #dee2e6 !important;
        cursor: not-allowed !important;
    }
    /* Remove default list styling */
    .dataTables_paginate ul {
        list-style: none !important;
        padding: 0 !important;
        margin: 0 !important;
        display: flex !important;
        flex-wrap: wrap !important;
        align-items: center !important;
    }
    .dataTables_paginate li {
        margin: 0 !important;
    }
    </style>

    <!-- Filter Controls -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Filters</h5>
            
            <!-- App/Instance Quick Filters -->
            <div class="filter-bar mb-2">
                <div style="margin-bottom: 0.5em;">
                    <span style="font-weight: 600;">Applications:</span>
                    <a href="#" data-filter="app_name" data-value="" class="filter-link {% if not selected_app %}filter-active{% endif %}">All</a>
                    {% for name in app_names %}
                        <a href="#" data-filter="app_name" data-value="{{ name }}" class="filter-link {% if selected_app == name %}filter-active{% endif %}">{{ name }}</a>
                    {% endfor %}
                </div>
                <div>
                    <span style="font-weight: 600;">Instances:</span>
                    <a href="#" data-filter="instance_name" data-value="" class="filter-link {% if not selected_instance %}filter-active{% endif %}">All</a>
                    {% for name in instance_names %}
                        <a href="#" data-filter="instance_name" data-value="{{ name }}" class="filter-link {% if selected_instance == name %}filter-active{% endif %}">{{ name }}</a>
                    {% endfor %}
                </div>
            </div>

            <!-- Time Range Filter -->
            <form id="time-range-form" class="row g-3">
                <div class="col-md-4">
                    <label for="start_time" class="form-label">Start Time</label>
                    <input type="datetime-local" class="form-control" id="start_time" name="start_time" value="{{ request.GET.start_time|default:'' }}">
                </div>
                <div class="col-md-4">
                    <label for="end_time" class="form-label">End Time</label>
                    <input type="datetime-local" class="form-control" id="end_time" name="end_time" value="{{ request.GET.end_time|default:'' }}">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" id="apply-time-filter" class="btn btn-primary me-2">Apply</button>
                    <button type="button" id="clear-time-filter" class="btn btn-outline-secondary">Clear</button>
                </div>
            </form>

            <!-- Active filters display -->
            <div id="active-filters" class="mt-2" style="display: none;">
                <strong>Active filters:</strong>
                <span id="filter-badges"></span>
                <button type="button" id="clear-all-filters" class="btn btn-link btn-sm p-0 ms-2">[clear all]</button>
            </div>
        </div>
    </div>

    <!-- DataTable -->
    <div class="table-responsive">
        <table id="logs-table" class="table table-striped table-bordered table-sm">
            <thead class="thead-dark">
                <tr>
                    <th>Timestamp</th>
                    <th>App Name</th>
                    <th>Instance Name</th>
                    <th>Level</th>
                    <th>Message</th>
                    <th>Module</th>
                    <th>Function</th>
                </tr>
            </thead>
            <tbody>
                <!-- DataTables will populate this via AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- External Dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize flatpickr for datetime inputs
    flatpickr("#start_time", { 
        enableTime: true, 
        dateFormat: "Y-m-d H:i", 
        allowInput: true 
    });
    flatpickr("#end_time", { 
        enableTime: true, 
        dateFormat: "Y-m-d H:i", 
        allowInput: true 
    });

    // Current filter state
    let currentFilters = {
        app_name: '{{ selected_app|default:"" }}',
        instance_name: '{{ selected_instance|default:"" }}',
        start_time: '{{ request.GET.start_time|default:"" }}',
        end_time: '{{ request.GET.end_time|default:"" }}'
    };

    // Initialize DataTable with server-side processing
    const table = $('#logs-table').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{% url "monitor_app:logs_datatable_ajax" %}',
            data: function(d) {
                // Add current filters to DataTables request
                d.app_name = currentFilters.app_name;
                d.instance_name = currentFilters.instance_name;
                d.start_time = currentFilters.start_time;
                d.end_time = currentFilters.end_time;
            }
        },
        columns: [
            { data: 0, name: 'timestamp' },
            { data: 1, name: 'app_name', orderable: true },
            { data: 2, name: 'instance_name', orderable: true },
            { data: 3, name: 'levelname', orderable: true },
            { data: 4, name: 'message', orderable: false },
            { data: 5, name: 'module', orderable: true },
            { data: 6, name: 'funcname', orderable: true }
        ],
        order: [[0, 'desc']], // Default sort by timestamp descending
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        responsive: true,
        language: {
            processing: "Loading logs...",
            search: "Search logs:",
            lengthMenu: "Show _MENU_ logs per page",
            info: "Showing _START_ to _END_ of _TOTAL_ logs",
            infoFiltered: "(filtered from _MAX_ total logs)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            },
            emptyTable: "No logs found matching your criteria."
        }
    });

    // Update URL and active filters display
    function updateUrlAndFilters() {
        // Update URL with current filters
        const params = new URLSearchParams();
        Object.keys(currentFilters).forEach(key => {
            if (currentFilters[key]) {
                params.set(key, currentFilters[key]);
            }
        });
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.history.replaceState({}, '', newUrl);

        // Update active filters display
        updateActiveFiltersDisplay();
        
        // Reload DataTable
        table.ajax.reload();
    }

    function updateActiveFiltersDisplay() {
        const badges = [];
        if (currentFilters.app_name) {
            badges.push(`<span class="badge bg-info me-1">App: ${currentFilters.app_name}</span>`);
        }
        if (currentFilters.instance_name) {
            badges.push(`<span class="badge bg-info me-1">Instance: ${currentFilters.instance_name}</span>`);
        }
        if (currentFilters.start_time) {
            badges.push(`<span class="badge bg-secondary me-1">From: ${currentFilters.start_time}</span>`);
        }
        if (currentFilters.end_time) {
            badges.push(`<span class="badge bg-secondary me-1">To: ${currentFilters.end_time}</span>`);
        }

        if (badges.length > 0) {
            $('#filter-badges').html(badges.join(''));
            $('#active-filters').show();
        } else {
            $('#active-filters').hide();
        }

        // Update filter link active states
        $('.filter-link').removeClass('filter-active');
        $('.filter-link[data-filter="app_name"][data-value="' + currentFilters.app_name + '"]').addClass('filter-active');
        $('.filter-link[data-filter="instance_name"][data-value="' + currentFilters.instance_name + '"]').addClass('filter-active');
    }

    // Handle filter link clicks
    $('.filter-link').on('click', function(e) {
        e.preventDefault();
        const filterType = $(this).data('filter');
        const filterValue = $(this).data('value');
        currentFilters[filterType] = filterValue;
        updateUrlAndFilters();
    });

    // Handle time range filters
    $('#apply-time-filter').on('click', function() {
        currentFilters.start_time = $('#start_time').val();
        currentFilters.end_time = $('#end_time').val();
        updateUrlAndFilters();
    });

    $('#clear-time-filter').on('click', function() {
        currentFilters.start_time = '';
        currentFilters.end_time = '';
        $('#start_time').val('');
        $('#end_time').val('');
        updateUrlAndFilters();
    });

    // Clear all filters
    $('#clear-all-filters').on('click', function() {
        currentFilters = {
            app_name: '',
            instance_name: '',
            start_time: '',
            end_time: ''
        };
        $('#start_time').val('');
        $('#end_time').val('');
        updateUrlAndFilters();
    });

    // Initialize display
    updateActiveFiltersDisplay();
});
</script>
{% endblock %}