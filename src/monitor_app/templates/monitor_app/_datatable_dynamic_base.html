{% extends "base.html" %}
{% comment %}
Enhanced base template for server-side DataTables with dynamic filtering.

Required context variables:
- table_title: Page title (e.g., "Log List")
- table_description: One-line description
- ajax_url: URL for DataTables AJAX endpoint
- filter_counts_url: URL for dynamic filter counts endpoint
- columns: List of column definitions for DataTables
- filter_fields: List of filter field configurations

Optional blocks:
- extra_filters: Additional custom filter controls
- initial_filters: JSON object of initial filter values
- default_order: DataTables order specification
- update_active_filters_display: JavaScript for custom filter display logic
- extra_scripts: Additional JavaScript

Filter field configuration format:
{
    'name': 'app_name',
    'label': 'Applications',
    'type': 'select'  // Currently only 'select' supported
}
{% endcomment %}

{% block title %}{{ table_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ table_title }}</h2>
    <p>{{ table_description }}</p>

    {% block extra_filters %}{% endblock %}

    <!-- Dynamic Filter Controls -->
    <div class="card mb-3">
        <div class="card-body">
            <div id="dynamic-filters" class="filter-bar mb-2">
                {% for field in filter_fields %}
                <div id="{{ field.name }}-filter" style="margin-bottom: 0.5em;">
                    <span style="font-weight: 600;">{{ field.label }}:</span>
                    <a href="#" data-filter="{{ field.name }}" data-value="" class="filter-link filter-active">All</a>
                    <span id="{{ field.name }}-options"></span>
                </div>
                {% endfor %}
            </div>

            <!-- Active filters display -->
            <div id="active-filters" class="mt-2" style="display: none;">
                <strong>Active filters:</strong>
                <span id="filter-badges"></span>
                <button type="button" id="clear-all-filters" class="btn btn-link btn-sm p-0 ms-2">clear all</button>
            </div>
        </div>
    </div>

    <!-- DataTable -->
    <div class="table-responsive">
        <table id="main-table" class="table table-striped table-bordered table-sm">
            <thead class="thead-dark">
                <tr>
                    {% for column in columns %}
                        <th>{{ column.title }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <!-- Data loaded via AJAX -->
            </tbody>
        </table>
    </div>

</div>

{% block extra_styles %}{% endblock %}

<style>
.filter-bar a {
    margin-right: 0.5em;
    color: #007bff;
    text-decoration: none;
}
.filter-bar a:hover {
    text-decoration: underline;
}
.filter-bar a.filter-active {
    font-weight: bold;
    text-decoration: underline;
    color: #0056b3;
}

/* DataTables styling */
#main-table_wrapper .top {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1rem;
}
#main-table_wrapper .dataTables_filter {
    margin-bottom: 0;
}
#main-table_wrapper .dataTables_filter label {
    display: flex;
    align-items: center;
    margin-bottom: 0;
}
#main-table_wrapper .dataTables_filter input {
    margin-left: 0.5rem;
}
#main-table_wrapper .bottom {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    margin-top: 0.75rem !important;
}
.dataTables_info {
    margin-bottom: 0 !important;
}
.dataTables_paginate {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
}

/* Clean pagination styling */
.dataTables_paginate {
    margin-top: 1rem !important;
}
.dataTables_paginate .paginate_button {
    display: inline-block !important;
    padding: 0.375rem 0.75rem !important;
    margin: 0 0.125rem !important;
    border: 1px solid #dee2e6 !important;
    border-radius: 0.25rem !important;
    background: white !important;
    color: #007bff !important;
    text-decoration: none !important;
    line-height: 1.5 !important;
}
.dataTables_paginate .paginate_button:hover {
    background: #e9ecef !important;
    border-color: #adb5bd !important;
}
.dataTables_paginate .paginate_button.current {
    background: #007bff !important;
    border-color: #007bff !important;
    color: white !important;
}
.dataTables_paginate .paginate_button.disabled {
    color: #6c757d !important;
    background: #e9ecef !important;
    border-color: #dee2e6 !important;
    cursor: not-allowed !important;
}
/* Remove default list styling */
.dataTables_paginate ul {
    list-style: none !important;
    padding: 0 !important;
    margin: 0 !important;
    display: flex !important;
    flex-wrap: wrap !important;
    align-items: center !important;
}
.dataTables_paginate li {
    margin: 0 !important;
}

#main-table_processing {
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 20px;
    text-align: center;
    font-weight: bold;
}
</style>

<!-- DataTables CSS/JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize current filters
    let currentFilters = {% block initial_filters %}{}{% endblock %};
    
    // Initialize DataTable
    let table = $('#main-table').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ ajax_url }}',
            data: function(d) {
                // Add current filters to request
                $.each(currentFilters, function(key, value) {
                    if (value !== '' && value !== null && value !== undefined) {
                        d[key] = value;
                    }
                });
            }
        },
        columns: [
            {% for column in columns %}
            { 
                data: null,
                orderable: {{ column.orderable|yesno:"true,false" }},
                render: function(data, type, row) {
                    return row[{{ forloop.counter0 }}];
                }
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        order: {% block default_order %}[[0, 'desc']]{% endblock %},
        pageLength: 100,
        lengthMenu: [[100, 300, 1000, -1], [100, 300, 1000, 'All']],
        dom: '<"top"f>rt<"bottom"ip><"clear">', // Search, table, processing, info and pagination
        responsive: true,
        pagingType: "full_numbers",
        language: {
            processing: 'Loading data...',
            search: "Search:",
            emptyTable: 'No records found.',
            zeroRecords: 'No matching records found.',
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: "First",
                last: "Last", 
                next: "Next",
                previous: "Previous"
            }
        },
    });

    // Store references globally for filter functions
    window.table = table;
    window.tableCurrentFilters = currentFilters;
    window.tableUpdateFilters = updateFilters;


    // Filter link click handler
    $(document).on('click', '.filter-link', function(e) {
        e.preventDefault();
        const filterType = $(this).data('filter');
        const filterValue = $(this).data('value');
        currentFilters[filterType] = filterValue;
        updateFilters();
    });

    // Clear all filters
    $('#clear-all-filters').on('click', function() {
        {% for field in filter_fields %}
        currentFilters.{{ field.name }} = '';
        {% endfor %}
        updateFilters();
    });

    // Function to update filters and refresh data
    function updateFilters() {
        // Update URL with current filters
        const urlParams = new URLSearchParams();
        $.each(currentFilters, function(key, value) {
            if (value !== '' && value !== null && value !== undefined) {
                urlParams.set(key, value);
            }
        });
        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newUrl);

        // Update filter display
        updateActiveFiltersDisplay();
        
        // Load dynamic filter options
        loadDynamicFilters();
        
        // Refresh table
        table.draw();
    }

    // Function to update active filters display
    function updateActiveFiltersDisplay() {
        {% block update_active_filters_display %}
        const badges = [];
        {% for field in filter_fields %}
        if (currentFilters.{{ field.name }} !== '' && currentFilters.{{ field.name }} !== null && currentFilters.{{ field.name }} !== undefined) {
            badges.push(`<span class="badge bg-info me-1">{{ field.name }}: ${currentFilters.{{ field.name }}}</span>`);
        }
        {% endfor %}

        if (badges.length > 0) {
            $('#filter-badges').html(badges.join('&nbsp;&nbsp;'));
            $('#active-filters').show();
        } else {
            $('#active-filters').hide();
        }

        // Update filter link active states
        $('.filter-link').removeClass('filter-active');
        {% for field in filter_fields %}
        $('.filter-link[data-filter="{{ field.name }}"][data-value="' + currentFilters.{{ field.name }} + '"]').addClass('filter-active');
        {% endfor %}
        {% endblock %}
    }

    // Function to load dynamic filter options with counts
    function loadDynamicFilters() {
        $.ajax({
            url: '{{ filter_counts_url }}',
            data: currentFilters,
            success: function(response) {
                const filterCounts = response.filter_counts;
                
                {% for field in filter_fields %}
                // Update {{ field.name }} options
                let {{ field.name }}Html = '';
                if (filterCounts.{{ field.name }}) {
                    filterCounts.{{ field.name }}.forEach(function(item) {
                        const value = item[0];
                        const count = item[1];
                        const activeClass = currentFilters.{{ field.name }} === value ? 'filter-active' : '';
                        {{ field.name }}Html += `<a href="#" data-filter="{{ field.name }}" data-value="${value}" class="filter-link ${activeClass}">${value} (${count})</a>`;
                    });
                }
                $('#{{ field.name }}-options').html({{ field.name }}Html);
                {% endfor %}
            },
            error: function() {
                console.log('Failed to load dynamic filters');
            }
        });
    }


    // Initial load
    updateActiveFiltersDisplay();
    loadDynamicFilters();

    {% block extra_scripts %}{% endblock %}
});
</script>

{% endblock %}