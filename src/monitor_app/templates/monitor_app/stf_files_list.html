{% extends 'base.html' %}

{% block title %}STF Files - SWF Monitor{% endblock %}

{% block content %}
<div class="container">
    <h2>STF (Super Time Frame) Files</h2>
    
    <style>
    .filter-bar a {
        margin-right: 0.5em;
        color: #007bff;
        text-decoration: none;
    }
    .filter-bar a.filter-active {
        font-weight: bold;
        text-decoration: underline;
        color: #0056b3;
    }
    .status-badge {
        padding: 0.25em 0.5em;
        border-radius: 0.25em;
        font-size: 0.8em;
        font-weight: bold;
    }
    </style>
    
    <div class="filter-bar" style="margin-bottom: 1em;">
        <div style="margin-bottom: 0.5em;">
            <span style="font-weight: 600;">Status:</span>
            <a href="?" class="{% if not status_filter %}filter-active{% endif %}">All</a>
            <a href="?status=REGISTERED" class="{% if status_filter == 'REGISTERED' %}filter-active{% endif %}">Registered</a>
            <a href="?status=PROCESSING" class="{% if status_filter == 'PROCESSING' %}filter-active{% endif %}">Processing</a>
            <a href="?status=PROCESSED" class="{% if status_filter == 'PROCESSED' %}filter-active{% endif %}">Processed</a>
            <a href="?status=FAILED" class="{% if status_filter == 'FAILED' %}filter-active{% endif %}">Failed</a>
        </div>
        <div>
            <span style="font-weight: 600;">Machine State:</span>
            <a href="?{% if status_filter %}status={{ status_filter }}&{% endif %}" class="{% if not machine_state_filter %}filter-active{% endif %}">All</a>
            {% for state in machine_states %}
                <a href="?{% if status_filter %}status={{ status_filter }}&{% endif %}machine_state={{ state|urlencode }}" class="{% if machine_state_filter == state %}filter-active{% endif %}">{{ state }}</a>
            {% endfor %}
        </div>
    </div>

    <div class="table-responsive">
        <table id="stf-files-table" class="table table-striped table-bordered table-sm">
            <thead class="thead-dark">
                <tr>
                    <th>STF Filename</th>
                    <th>Run</th>
                    <th>Machine State</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for file in stf_files %}
                <tr>
                    <td style="white-space: normal; word-break: break-all;">
                        <span title="{{ file.stf_filename }}">{{ file.stf_filename }}</span>
                    </td>
                    <td>
                        <a href="{% url 'monitor_app:run_detail' file.run.run_id %}">{{ file.run.run_number }}</a>
                    </td>
                    <td>{{ file.machine_state }}</td>
                    <td>
                        <span class="badge badge-{% if file.status == 'REGISTERED' %}primary{% elif file.status == 'PROCESSING' %}warning{% elif file.status == 'PROCESSED' %}success{% elif file.status == 'FAILED' %}danger{% else %}secondary{% endif %}">
                            {{ file.get_status_display }}
                        </span>
                    </td>
                    <td>{{ file.created_at|date:"Ymd H:i:s" }}</td>
                    <td>
                        <a href="{% url 'monitor_app:stf_file_detail' file.file_id %}">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script>
      $(document).ready(function() {
        var table = $('#stf-files-table').DataTable({
          paging: true,
          pageLength: 50,
          lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, 'All']],
          ordering: true,
          order: [[4, 'desc']],
          info: true,
          searching: true,
          responsive: true,
          search: {
            caseInsensitive: true,
            smart: false,
            regex: false
          },
          language: {
            search: "Filter table:",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ files",
            emptyTable: "No STF files found.",
            paginate: {
              first: "First",
              last: "Last",
              next: "Next",
              previous: "Previous"
            }
          }
        });
        $(table.table().container()).find('input[type="search"]').css({'width':'24em','display':'inline-block'});
      });
    </script>
</div>
{% endblock %}