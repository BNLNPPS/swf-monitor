{% extends 'base.html' %}

{% block title %}Run {{ run.run_number }} Details - SWF Monitor{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Run {{ run.run_number }} Details</h2>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Run Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Run Number:</th>
                                    <td>{{ run.run_number }}</td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td>
                                        {% if run.end_time %}
                                            <span class="badge badge-secondary">Completed</span>
                                        {% else %}
                                            <span class="badge badge-success">Active</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Start Time:</th>
                                    <td>{{ run.start_time|date:"Y-m-d H:i:s" }}</td>
                                </tr>
                                <tr>
                                    <th>End Time:</th>
                                    <td>{{ run.end_time|date:"Y-m-d H:i:s"|default:"—" }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Duration:</th>
                                    <td>
                                        {% if run.end_time %}
                                            {{ run.end_time|timeuntil:run.start_time }}
                                        {% else %}
                                            {{ run.start_time|timesince }} (ongoing)
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>STF Files:</th>
                                    <td>{{ run.stf_files.count }}</td>
                                </tr>
                                <tr>
                                    <th>Run ID:</th>
                                    <td>{{ run.run_id }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    {% if run.run_conditions %}
                    <h6 class="mt-3">Run Conditions</h6>
                    <pre class="bg-light p-2 rounded">{{ run.run_conditions|safe }}</pre>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">STF Files ({{ run.stf_files.count }})</h5>
                </div>
                <div class="card-body">
                    {% if stf_files %}
                    <div class="table-responsive">
                        <table id="stf-files-table" class="table table-striped table-bordered table-sm">
                            <thead class="thead-dark">
                                <tr>
                                    <th>File URL</th>
                                    <th>Machine State</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in stf_files %}
                                <tr>
                                    <td style="white-space: normal; word-break: break-all;">
                                        <a href="{{ file.file_url }}" target="_blank">{{ file.file_url|truncatechars:80 }}</a>
                                    </td>
                                    <td>{{ file.machine_state }}</td>
                                    <td>
                                        <span class="badge badge-{% if file.status == 'REGISTERED' %}primary{% elif file.status == 'PROCESSING' %}warning{% elif file.status == 'PROCESSED' %}success{% elif file.status == 'FAILED' %}danger{% else %}secondary{% endif %}">
                                            {{ file.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ file.created_at|date:"Ymd H:i:s" }}</td>
                                    <td>
                                        <a href="{% url 'monitor_app:stf_file_detail' file.file_id %}">View</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No STF files found for this run.</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="mt-3">
                <a href="{% url 'monitor_app:runs_list' %}" class="btn btn-secondary">← Back to Runs</a>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script>
  $(document).ready(function() {
    $('#stf-files-table').DataTable({
      paging: true,
      pageLength: 25,
      lengthMenu: [[10, 25, 50, -1], [10, 25, 50, 'All']],
      ordering: true,
      order: [[3, 'desc']],
      info: true,
      searching: true,
      responsive: true,
      language: {
        search: "Filter files:",
        lengthMenu: "Show _MENU_ files",
        info: "Showing _START_ to _END_ of _TOTAL_ files",
        emptyTable: "No STF files found for this run.",
        paginate: {
          first: "First",
          last: "Last",
          next: "Next",
          previous: "Previous"
        }
      }
    });
    $(table.table().container()).find('input[type="search"]').css({'width':'24em','display':'inline-block'});
  });
</script>
{% endblock %}