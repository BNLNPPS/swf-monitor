{% extends 'base.html' %}

{% block title %}Workflow Detail: {{ workflow.filename }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1>Workflow Detail</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">{{ workflow.filename }}</h5>
        </div>
        <div class="card-body">
            <p><strong>Workflow ID:</strong> {{ workflow.workflow_id }}</p>
            <p><strong>Status:</strong> <span class="badge badge-{% if workflow.current_status == 'workflow_complete' %}success{% elif workflow.current_status == 'failed' %}danger{% else %}warning{% endif %}">{{ workflow.get_current_status_display }}</span></p>
            <p><strong>Current Agent:</strong> {{ workflow.get_current_agent_display }}</p>
            <p><strong>DAQ State:</strong> {{ workflow.daq_state }} / {{ workflow.daq_substate }}</p>
            <p><strong>Generated:</strong> {{ workflow.generated_time|date:"Ymd-H:i:s" }}</p>
            <p><strong>Last Updated:</strong> {{ workflow.updated_at|date:"Ymd-H:i:s" }}</p>
            {% if workflow_duration %}
            <p><strong>Total Duration:</strong> {{ workflow_duration|floatformat:2 }} seconds</p>
            {% endif %}
        </div>
    </div>

    <h2>Workflow Stages</h2>
    <div class="table-responsive mb-4">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Agent</th>
                    <th>Status</th>
                    <th>Received</th>
                    <th>Started</th>
                    <th>Completed</th>
                    <th>Duration (s)</th>
                </tr>
            </thead>
            <tbody>
                {% for stage in stages %}
                <tr>
                    <td>{{ stage.get_agent_type_display }}</td>
                    <td>{{ stage.get_status_display }}</td>
                    <td>{{ stage.received_at|date:"Ymd-H:i:s"|default:"N/A" }}</td>
                    <td>{{ stage.started_at|date:"Ymd-H:i:s"|default:"N/A" }}</td>
                    <td>{{ stage.completed_at|date:"Ymd-H:i:s"|default:"N/A" }}</td>
                    <td>{{ stage.processing_time_seconds|floatformat:2|default:"N/A" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">No stages found for this workflow.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h2>Workflow Messages</h2>
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Type</th>
                    <th>Sender</th>
                    <th>Recipient</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for message in messages %}
                <tr>
                    <td>{{ message.sent_at|date:"Ymd-H:i:s" }}</td>
                    <td>{{ message.message_type }}</td>
                    <td>{{ message.sender_agent }}</td>
                    <td>{{ message.recipient_agent }}</td>
                    <td>
                        {% if message.is_successful %}
                            <span class="badge badge-success">Success</span>
                        {% else %}
                            <span class="badge badge-danger">Failed</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">No messages found for this workflow.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}
