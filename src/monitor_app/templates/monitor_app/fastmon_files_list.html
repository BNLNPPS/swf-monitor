{% extends "monitor_app/_datatable_base.html" %}

{% block extra_filters %}
<!-- Filter Controls -->
<div class="card mb-3">
    <div class="card-body">

        <!-- Status/Parent STF/Run Number Quick Filters -->
        <div class="filter-bar mb-2">
            <div style="margin-bottom: 0.5em;">
                <span style="font-weight: 600;">Status:</span>
                <a href="#" data-filter="status" data-value="" class="filter-link {% if not selected_status %}filter-active{% endif %}">All</a>
                {% for status in statuses %}
                    <a href="#" data-filter="status" data-value="{{ status }}" class="filter-link {% if selected_status == status %}filter-active{% endif %}">{{ status }}</a>
                {% endfor %}
            </div>
            <div style="margin-bottom: 0.5em;">
                <span style="font-weight: 600;">Parent STF:</span>
                <a href="#" data-filter="stf_filename" data-value="" class="filter-link {% if not selected_stf_filename %}filter-active{% endif %}">All</a>
                {% for stf in stf_filenames|slice:":20" %}
                    <a href="#" data-filter="stf_filename" data-value="{{ stf }}" class="filter-link {% if selected_stf_filename == stf %}filter-active{% endif %}" title="{{ stf }}">{{ stf|truncatechars:30 }}</a>
                {% endfor %}
                {% if stf_filenames|length > 20 %}
                    <span style="color: #6c757d; font-style: italic;">... and {{ stf_filenames|length|add:"-20" }} more</span>
                {% endif %}
            </div>
            <div>
                <span style="font-weight: 600;">Run Numbers:</span>
                <a href="#" data-filter="run_number" data-value="" class="filter-link {% if not selected_run_number %}filter-active{% endif %}">All</a>
                {% for run_num in run_numbers|slice:":100" %}
                    <a href="#" data-filter="run_number" data-value="{{ run_num }}" class="filter-link {% if selected_run_number == run_num|stringformat:"s" %}filter-active{% endif %}">{{ run_num }}</a>
                {% endfor %}
                {% if run_numbers|length > 100 %}
                    <span style="color: #6c757d; font-style: italic;">... and {{ run_numbers|length|add:"-100" }} more</span>
                {% endif %}
            </div>
        </div>

        <!-- Active filters display -->
        <div id="active-filters" class="mt-2" style="display: none;">
            <strong>Active filters:</strong>
            <span id="filter-badges"></span>
            <button type="button" id="clear-all-filters" class="btn btn-link btn-sm p-0 ms-2">clear all</button>
        </div>
    </div>
</div>
{% endblock %}

{% block initial_filters %}
{
    status: '{{ selected_status|default:"" }}',
    stf_filename: '{{ selected_stf_filename|default:"" }}',
    run_number: '{{ selected_run_number|default:"" }}'
}
{% endblock %}

{% block default_order %}[[5, 'desc']]{% endblock %} <!-- Order by created_at descending -->

{% block update_active_filters_display %}
const badges = [];
// Combine filters into concise format
const parts = [];
if (currentFilters.status) parts.push(currentFilters.status);
if (currentFilters.stf_filename) {
    // Truncate long STF filenames for display
    const truncatedStf = currentFilters.stf_filename.length > 20
        ? currentFilters.stf_filename.substring(0, 20) + '...'
        : currentFilters.stf_filename;
    parts.push(`STF:${truncatedStf}`);
}
if (currentFilters.run_number) parts.push(`Run:${currentFilters.run_number}`);

if (parts.length > 0) {
    badges.push(`<span class="badge bg-info me-1">${parts.join('/')}</span>`);
}

if (badges.length > 0) {
    $('#filter-badges').html(badges.join('&nbsp;&nbsp;'));
    $('#active-filters').show();
} else {
    $('#active-filters').hide();
}

// Update filter link active states
$('.filter-link').removeClass('filter-active');
$('.filter-link[data-filter="status"][data-value="' + currentFilters.status + '"]').addClass('filter-active');
$('.filter-link[data-filter="stf_filename"][data-value="' + currentFilters.stf_filename + '"]').addClass('filter-active');
$('.filter-link[data-filter="run_number"][data-value="' + currentFilters.run_number + '"]').addClass('filter-active');
{% endblock %}

{% block extra_scripts %}
// Handle filter link clicks
$('.filter-link').on('click', function(e) {
    e.preventDefault();
    const filterType = $(this).data('filter');
    const filterValue = $(this).data('value');
    window.tableCurrentFilters[filterType] = filterValue;
    window.tableUpdateFilters();
});

// Clear all filters
$('#clear-all-filters').on('click', function() {
    // Clear the actual currentFilters object used by the table
    window.tableCurrentFilters.status = '';
    window.tableCurrentFilters.stf_filename = '';
    window.tableCurrentFilters.run_number = '';

    // Update the table and URL
    window.tableUpdateFilters();
});
{% endblock %}